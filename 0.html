<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>GojoMangaBot</title> 
  <style>
    :root {
      --box-bg: #ffffff;
      --accent-link-color: #0088cc;
    }
 
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f0f0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    .loading-wrapper {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 320px;
      max-width: 90%;
      background: white;
      border-radius: 20px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
      padding: 30px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      text-align: center;
      z-index: 9999;
    }

    .loading-logo {
      width: 96px;
      height: 96px;
      border-radius: 50%;
      object-fit: cover;
    }

    .loading-title {
      font-size: 20px;
      font-weight: bold;
    }

    .loading-extra {
      font-size: 14px;
      color: #555;
    }

    .loading-text {
      font-size: 16px;
      color: #555;
      font-weight: bold;
      margin-top: 12px;
      transition: color 0.3s ease;
    }

    .loading-text.success { color: green; }
    .loading-text.blocked { color: red; }
    .loading-text.chapters_no { color: #800080; }

    .photo-container {
      display: none;
      padding: 0 12px;
      flex-direction: column;
      align-items: center;
      width: 100%;
      max-width: 600px;
      padding: 10px;
      overflow-y: auto;
      height: calc(100 * var(--vh));
      pointer-events: auto;
      box-sizing: border-box;
      margin: 16px 0;
    }

    .chapter-photo {
      display: block;
      margin: 0;
      width: 100%;
      max-width: 600px;
      user-select: none;
      -webkit-user-drag: none;
      pointer-events: none;
    }

    #scroll-track {
      position: fixed;
      right: 10px;
      top: 10px;
      height: calc(100 * var(--vh) - 20px);
      width: 6px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 3px;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 1000;
    }

    .thumb {
      position: absolute;
      width: 100%;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 3px;
      top: 0;
      left: 0;
    }

    #page-indicator {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 5px 10px;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      border-radius: 5px;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      user-select: none;
      z-index: 1000;
      font-weight: 600;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="loading-wrapper" id="loading-screen">
    <img class="loading-logo" src="https://cdn4.cdn-telegram.org/file/VJsUqPLWZiucMadLzaEyH2fXS11bZ2hgTZQlUl-sWrmPpODM3CUM6Z4NtxsRtdVoTFtVmQW_dRh2zhb1aRdHcrqKv-wtuTWoejBFqH5e50Smqti2_9wpO9zPkcHOSZrNy1aRTKhMRUWlIKVr6c8BCe1w41lFH-wnfB2tEsR9XiYqnEAGEucU7I_LfnOKRpBtUz79t9-flwdOCMqH9iWb7pPWQ_oDOJzNApX3KsSc8BFvsTa51YyPeaOVhzmQ_KqiNM_368pAGsXAzTn7ZzdofrqtY4666jLVHl-lmgkFbprHFmIKElqd6luHuAhbBSav4ZamurKQzoNCAzcusBz13A.jpg" />
    <div class="loading-title">Gojo Manga Bot</div>
    <div class="loading-extra"><a href="https://t.me/GojoMangaBot">@GojoMangaBot</a></div>
    <div class="loading-extra">üî∞ –ü–æ–¥–¥–µ—Ä–∂–∫–∞: <a href="https://t.me/mario_npc">@mario_npc</a></div>
    <div class="loading-text" id="loading-text">‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...</div>
  </div>

  <div id="scrollable" class="photo-container"></div>
  <div id="scroll-track"><div class="thumb"></div></div>
  <div id="page-indicator"></div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è Telegram Web App
    if (!window.Telegram) {
      window.Telegram = {
        WebApp: {
          ready: () => {},
          disableVerticalSwipes: () => {},
          MainButton: {
            setText: () => {},
            show: () => {},
            onClick: () => {},
            close: () => {}
          },
          close: () => {}
        }
      };
    }

    const loadingScreen = document.getElementById('loading-screen');
    const loadingText = document.getElementById('loading-text');
    const scrollable = document.getElementById('scrollable');
    const track = document.getElementById('scroll-track');
    const thumb = track.querySelector('.thumb');
    const pageInd = document.getElementById('page-indicator');

    let wrappers = [], total = 0, trackHideTimeout, indicatorHideTimeout, ticking = false, pdfDoc = null;

    function updateVh() {
      document.documentElement.style.setProperty('--vh', (window.innerHeight * 0.01) + 'px');
    }
    window.addEventListener('resize', updateVh);
    updateVh();

    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        site_url: params.get('site_url'),
        cookie: params.get('cookie'),
        user_id: params.get('user_id'),
        title_id: params.get('title_id'),
        chapter_number: params.get('chapter_number'),
        status: params.get('status')
      };
    }

    function updateLoadingStatus(status, customText) {
      loadingText.className = 'loading-text';
      if (status === 'success') {
        loadingText.textContent = customText || 'üü¢ –£—Å–ø–µ—à–Ω–æ';
        loadingText.classList.add('success');
      } else if (status === 'blocked') {
        loadingText.textContent = customText || 'üî¥ –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã';
        loadingText.classList.add('blocked');
      } else if (status === 'chapters_no') {
        loadingText.textContent = customText || 'üü£ –ì–ª–∞–≤—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç';
        loadingText.classList.add('chapters_no');
      } else {
        loadingText.textContent = customText || 'üü° –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
      }
    }

    async function renderPage(pdf, pageNum) {
      try {
        console.log(`–†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${pageNum}`);
        const page = await pdf.getPage(pageNum);
        const containerWidth = scrollable.clientWidth;
        const scale = Math.min(containerWidth / page.getViewport({ scale: 1 }).width, 1.0);
        const viewport = page.getViewport({ scale });
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.width = viewport.width;
        canvas.height = viewport.height;

        await page.render({ canvasContext: context, viewport }).promise;

        const wrapper = document.createElement('div');
        wrapper.dataset.pageNum = pageNum; // –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        const img = document.createElement('img');
        img.src = canvas.toDataURL('image/jpeg', 0.8);
        img.className = 'chapter-photo';
        img.alt = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${pageNum}`;
        img.loading = 'lazy';
        wrapper.appendChild(img);

        // –û—á–∏—Å—Ç–∫–∞ canvas
        canvas.width = 0;
        canvas.height = 0;

        return wrapper;
      } catch (err) {
        console.error(`–û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${pageNum}:`, err);
        return null;
      }
    }

    async function fetchImages(site_url, cookie, user_id, title_id, chapter_number) {
      const url = `${site_url}manga_chapter.php?cookie=${encodeURIComponent(cookie)}&user_id=${user_id}&title_id=${title_id}&chapter_number=${chapter_number}`;
      try {
        updateLoadingStatus(null, '‚è≥ –ü–æ–ª—É—á–∞–µ–º PDF...');
        const response = await fetch(url);
        if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${response.status}`);
        const buffer = await response.arrayBuffer();
        pdfDoc = await pdfjsLib.getDocument({ data: buffer }).promise;
        total = pdfDoc.numPages;
        if (total === 0) {
          updateLoadingStatus('chapters_no', 'üü£ –ì–ª–∞–≤—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç');
          return;
        }
        updateLoadingStatus(null, `‚è≥ –î–æ–∫—É–º–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω: ${total} —Å—Ç—Ä–∞–Ω–∏—Ü`);

        wrappers = [];

        // –†–µ–Ω–¥–µ—Ä–∏–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
        const firstWrapper = await renderPage(pdfDoc, 1);
        if (!firstWrapper) {
          updateLoadingStatus('blocked', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã');
          return;
        }
        scrollable.appendChild(firstWrapper);
        wrappers.push(firstWrapper);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Ñ–æ—Ç–æ –∏ –ø—Ä—è—á–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        loadingScreen.style.display = 'none';
        scrollable.style.display = 'flex';

        // –û–±—Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø–æ–¥–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ
        const observer = new IntersectionObserver(async (entries) => {
          for (const entry of entries) {
            if (entry.isIntersecting) {
              // –¢–µ–∫—É—â–∞—è –ø–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞, –∫–æ—Ç–æ—Ä–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω–∞
              const currentPage = wrappers.length;
              if (currentPage < total) {
                const nextPage = currentPage + 1;
                updateLoadingStatus(null, `‚è≥ –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${nextPage} –∏–∑ ${total}`);
                const wrapper = await renderPage(pdfDoc, nextPage);
                if (wrapper) {
                  scrollable.appendChild(wrapper);
                  wrappers.push(wrapper);
                  console.log(`–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${nextPage} –∑–∞–≥—Ä—É–∂–µ–Ω–∞`);

                  // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç —Å—Ç–∞—Ä–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
                  observer.unobserve(entry.target);
                  // –ù–∞–±–ª—é–¥–∞–µ–º –∑–∞ –Ω–æ–≤—ã–º –ø–æ—Å–ª–µ–¥–Ω–∏–º —ç–ª–µ–º–µ–Ω—Ç–æ–º
                  observer.observe(wrapper);

                  // –ï—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∏–ª–∏ –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã - –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                  if (wrappers.length === total) {
                    updateLoadingStatus('success', `üü¢ –í—Å–µ ${total} —Å—Ç—Ä–∞–Ω–∏—Ü –∑–∞–≥—Ä—É–∂–µ–Ω—ã`);
                  }
                }
              }
            }
          }
        }, {
          root: scrollable,
          threshold: 0.1
        });

        // –ù–∞–±–ª—é–¥–∞–µ–º –∑–∞ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ–π
        observer.observe(wrappers[wrappers.length - 1]);

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ —Ç—Ä–µ–∫ –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ
        scrollable.addEventListener('scroll', () => {
          if (!ticking) {
            window.requestAnimationFrame(() => {
              const scrollTop = scrollable.scrollTop;
              const scrollHeight = scrollable.scrollHeight - scrollable.clientHeight;
              const thumbHeight = Math.max(scrollable.clientHeight / scrollable.scrollHeight * track.clientHeight, 20);
              const scrollPercent = scrollTop / scrollHeight;
              const thumbPos = scrollPercent * (track.clientHeight - thumbHeight);

              thumb.style.height = thumbHeight + 'px';
              thumb.style.top = thumbPos + 'px';

              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç—Ä–µ–∫
              track.style.opacity = '1';
              clearTimeout(trackHideTimeout);
              trackHideTimeout = setTimeout(() => {
                track.style.opacity = '0';
              }, 500);

              // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é –≤–∏–¥–∏–º—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
              let visiblePageNum = 1;
              for (let i = 0; i < wrappers.length; i++) {
                const rect = wrappers[i].getBoundingClientRect();
                if (rect.top >= 0 && rect.top < window.innerHeight * 0.8) {
                  visiblePageNum = i + 1;
                  break;
                }
              }

              pageInd.textContent = `${visiblePageNum} / ${total}`;
              pageInd.style.opacity = '1';
              clearTimeout(indicatorHideTimeout);
              indicatorHideTimeout = setTimeout(() => {
                pageInd.style.opacity = '0';
              }, 1000);

              ticking = false;
            });
            ticking = true;
          }
        });

      } catch (error) {
        console.error(error);
        updateLoadingStatus('blocked', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ PDF');
      }
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –ø—Ä–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Telegram WebApp
    Telegram.WebApp.ready();

    const params = getUrlParams();

    // –ó–∞–ø—É—Å–∫–∞–µ–º
    fetchImages(params.site_url, params.cookie, params.user_id, params.title_id, params.chapter_number);
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>GojoMangaBot</title> 
  <style>
    :root {
      --box-bg: #ffffff;
      --accent-link-color: #0088cc;
    }
 
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f0f0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    .loading-wrapper {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 320px;
      max-width: 90%;
      background: white;
      border-radius: 20px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
      padding: 30px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      text-align: center;
      z-index: 9999;
    }

    .loading-logo {
      width: 96px;
      height: 96px;
      border-radius: 50%;
      object-fit: cover;
    }

    .loading-title {
      font-size: 20px;
      font-weight: bold;
    }

    .loading-extra {
      font-size: 14px;
      color: #555;
    }

    .loading-text {
      font-size: 16px;
      color: #555;
      font-weight: bold;
      margin-top: 12px;
      transition: color 0.3s ease;
    }

    .loading-text.success { color: green; }
    .loading-text.blocked { color: red; }
    .loading-text.chapters_no { color: #800080; }

    .photo-container {
      display: none;
      padding: 0 12px;
      flex-direction: column;
      align-items: center;
      width: 100%;
      max-width: 600px;
      padding: 10px;
      overflow-y: auto;
      height: calc(100 * var(--vh));
      box-sizing: border-box;
      margin: 16px 0;
    }

    .chapter-photo {
      display: block;
      margin: 0;
      width: 100%;
      max-width: 600px;
      user-select: none;
      -webkit-user-drag: none;
    }

    #scroll-track {
      position: fixed;
      right: 10px;
      top: 10px;
      height: calc(100 * var(--vh) - 20px);
      width: 6px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 3px;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 1000;
    }

    .thumb {
      position: absolute;
      width: 100%;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 3px;
      top: 0;
      left: 0;
    }

    #page-indicator {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 5px 10px;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      border-radius: 5px;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      user-select: none;
      z-index: 1000;
      font-weight: 600;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="loading-wrapper" id="loading-screen">
    <img class="loading-logo" src="https://cdn4.cdn-telegram.org/file/VJsUqPLWZiucMadLzaEyH2fXS11bZ2hgTZQlUl-sWrmPpODM3CUM6Z4NtxsRtdVoTFtVmQW_dRh2zhb1aRdHcrqKv-wtuTWoejBFqH5e50Smqti2_9wpO9zPkcHOSZrNy1aRTKhMRUWlIKVr6c8BCe1w41lFH-wnfB2tEsR9XiYqnEAGEucU7I_LfnOKRpBtUz79t9-flwdOCMqH9iWb7pPWQ_oDOJzNApX3KsSc8BFvsTa51YyPeaOVhzmQ_KqiNM_368pAGsXAzTn7ZzdofrqtY4666jLVHl-lmgkFbprHFmIKElqd6luHuAhbBSav4ZamurKQzoNCAzcusBz13A.jpg" />
    <div class="loading-title">Gojo Manga Bot</div>
    <div class="loading-extra"><a href="https://t.me/GojoMangaBot">@GojoMangaBot</a></div>
    <div class="loading-extra">üî∞ –ü–æ–¥–¥–µ—Ä–∂–∫–∞: <a href="https://t.me/mario_npc">@mario_npc</a></div>
    <div class="loading-text" id="loading-text">‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...</div>
  </div>

  <div id="scrollable" class="photo-container"></div>
  <div id="scroll-track"><div class="thumb"></div></div>
  <div id="page-indicator"></div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è Telegram Web App
    if (!window.Telegram) {
      window.Telegram = {
        WebApp: {
          ready: () => {},
          disableVerticalSwipes: () => {},
          MainButton: {
            setText: () => {},
            show: () => {},
            onClick: () => {},
            close: () => {}
          },
          close: () => {}
        }
      };
    }

    const loadingScreen = document.getElementById('loading-screen');
    const loadingText = document.getElementById('loading-text');
    const scrollable = document.getElementById('scrollable');
    const track = document.getElementById('scroll-track');
    const thumb = track.querySelector('.thumb');
    const pageInd = document.getElementById('page-indicator');

    let wrappers = [], total = 0, trackHideTimeout, indicatorHideTimeout, ticking = false, pdfDoc = null;

    function updateVh() {
      document.documentElement.style.setProperty('--vh', (window.innerHeight * 0.01) + 'px');
    }
    window.addEventListener('resize', updateVh);
    updateVh();

    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        site_url: params.get('site_url'),
        cookie: params.get('cookie'),
        user_id: params.get('user_id'),
        title_id: params.get('title_id'),
        chapter_number: params.get('chapter_number'),
        status: params.get('status')
      };
    }

    function updateLoadingStatus(status, customText) {
      loadingText.className = 'loading-text';
      if (status === 'success') {
        loadingText.textContent = customText || 'üü¢ –£—Å–ø–µ—à–Ω–æ';
        loadingText.classList.add('success');
      } else if (status === 'blocked') {
        loadingText.textContent = customText || 'üî¥ –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã';
        loadingText.classList.add('blocked');
      } else if (status === 'chapters_no') {
        loadingText.textContent = customText || 'üü£ –ì–ª–∞–≤—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç';
        loadingText.classList.add('chapters_no');
      } else {
        loadingText.textContent = customText || 'üü° –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
      }
    }

    async function renderPage(pdf, pageNum) {
      try {
        console.log(`–†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${pageNum}`);
        const startTime = performance.now();
        const page = await pdf.getPage(pageNum);
        const containerWidth = scrollable.clientWidth;
        const scale = Math.min(containerWidth / page.getViewport({ scale: 1 }).width, 1.0); // –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –º–∞—Å—à—Ç–∞–±
        const viewport = page.getViewport({ scale });
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.width = viewport.width;
        canvas.height = viewport.height;

        console.log(`–†–∞–∑–º–µ—Ä—ã canvas –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${pageNum}: ${canvas.width}x${canvas.height}`);

        const renderTask = page.render({ canvasContext: context, viewport });
        await renderTask.promise;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞, –∑–∞–ø–æ–ª–Ω–µ–Ω –ª–∏ canvas
        const imageData = context.getImageData(0, 0, canvas.width, canvas.height).data;
        const isCanvasEmpty = Array.from(imageData).every(val => val === 0);
        if (isCanvasEmpty) {
          throw new Error(`Canvas –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${pageNum} –ø—É—Å—Ç–æ–π`);
        }

        const imgData = canvas.toDataURL('image/jpeg', 0.8);
        console.log(`–†–∞–∑–º–µ—Ä data:URL –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${pageNum}: ${(imgData.length / 1024).toFixed(2)} –ö–ë`);

        if (!imgData.startsWith('data:image/jpeg') || imgData.length < 1000) {
          throw new Error(`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π data:URL –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${pageNum}`);
        }

        const wrapper = document.createElement('div');
        wrapper.dataset.pageNum = pageNum;
        const img = document.createElement('img');
        img.src = imgData;
        img.className = 'chapter-photo';
        img.alt = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${pageNum}`;
        img.loading = 'lazy';
        wrapper.appendChild(img);

        // –û—á–∏—Å—Ç–∫–∞ canvas
        canvas.width = 0;
        canvas.height = 0;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        img.onload = () => console.log(`–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${pageNum} —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –≤ <img>`);
        img.onerror = () => {
          console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${pageNum}`);
          updateLoadingStatus(null, `üü° –û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${pageNum}`);
        };

        console.log(`–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${pageNum} –æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω–∞ –∑–∞ ${(performance.now() - startTime).toFixed(2)} –º—Å`);
        return wrapper;
      } catch (err) {
        console.error(`–û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${pageNum}:`, err);
        updateLoadingStatus(null, `üü° –û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${pageNum}: ${err.message}`);
        return null;
      }
    }

    async function fetchImages(site_url, cookie, user_id, title_id, chapter_number, status) {
      if (status !== 'success') {
        updateLoadingStatus(status);
        return;
      }

      try {
        console.log('–ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ PDF...');
        const startTime = performance.now();
        updateLoadingStatus(null, '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ PDF...');

        const response = await fetch(site_url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ cookie, user_id, title_id, chapter_number })
        });

        if (!response.ok) throw new Error(`HTTP –æ—à–∏–±–∫–∞: ${response.status} ${response.statusText}`);

        const pdfBytes = await response.arrayBuffer();
        console.log(`PDF –∑–∞–≥—Ä—É–∂–µ–Ω –∑–∞ ${(performance.now() - startTime).toFixed(2)} –º—Å, —Ä–∞–∑–º–µ—Ä: ${(pdfBytes.byteLength / 1024 / 1024).toFixed(2)} –ú–ë`);

        updateLoadingStatus(null, '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ PDF...');
        pdfDoc = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
        total = pdfDoc.numPages;
        wrappers = [];
        scrollable.innerHTML = '';

        updateLoadingStatus(null, `‚è≥ –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã 1 –∏–∑ ${total}`);
        let firstWrapper = await renderPage(pdfDoc, 1);
        if (!firstWrapper && total > 1) {
          console.log('–ü–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –æ—Ç—Ä–µ–Ω–¥–µ—Ä–∏–ª–∞—Å—å, –ø—Ä–æ–±—É–µ–º –≤—Ç–æ—Ä—É—é...');
          updateLoadingStatus(null, `‚è≥ –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã 2 –∏–∑ ${total}`);
          firstWrapper = await renderPage(pdfDoc, 2);
        }
        if (!firstWrapper) {
          throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–Ω–¥–µ—Ä–∏—Ç—å –Ω–∞—á–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É');
        }

        scrollable.appendChild(firstWrapper);
        wrappers.push(firstWrapper);
        console.log('–ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ DOM');

        loadingScreen.style.display = 'none';
        scrollable.style.display = 'flex';
        updateThumb();
        showPageIndicator();

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ IntersectionObserver
        const observer = new IntersectionObserver(async (entries) => {
          for (const entry of entries) {
            if (entry.isIntersecting && wrappers.length < total) {
              const nextPage = wrappers.length + 1;
              updateLoadingStatus(null, `‚è≥ –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${nextPage} –∏–∑ ${total}`);
              const wrapper = await renderPage(pdfDoc, nextPage);
              if (wrapper) {
                scrollable.appendChild(wrapper);
                wrappers.push(wrapper);
                observer.unobserve(entry.target);
                observer.observe(wrapper);
                console.log(`–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${nextPage} –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ DOM`);
              }
            }
          }
        }, { root: scrollable, threshold: 0.1 });

        if (wrappers.length > 0) {
          observer.observe(wrappers[wrappers.length - 1]);
        }

      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ PDF:', err);
        updateLoadingStatus(null, `üü° –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–ª–∞–≤—ã: ${err.message}`);
      }
    }

    function updateThumb() {
      const scrollHeight = scrollable.scrollHeight - scrollable.clientHeight;
      if (scrollHeight <= 0) {
        thumb.style.height = `0px`;
        return;
      }
      const trackHeight = track.clientHeight;
      const thumbHeight = (scrollable.clientHeight / scrollable.scrollHeight) * trackHeight;
      const thumbTop = (scrollable.scrollTop / scrollHeight) * trackHeight;
      thumb.style.height = `${thumbHeight}px`;
      thumb.style.top = `${thumbTop}px`;
    }

    function currentIndex() {
      const mid = window.innerHeight / 2;
      for (let i = 0; i < wrappers.length; i++) {
        const rect = wrappers[i].getBoundingClientRect();
        if (rect.top <= mid && rect.bottom >= mid) return i + 1;
      }
      return 1;
    }

    function showPageIndicator() {
      if (total === 0) return;
      pageInd.textContent = `${currentIndex()} / ${total}`;
      pageInd.style.opacity = 1;
      clearTimeout(indicatorHideTimeout);
      indicatorHideTimeout = setTimeout(() => { pageInd.style.opacity = 0; }, 1500);
    }

    scrollable.addEventListener('click', (e) => {
      const rect = scrollable.getBoundingClientRect();
      const y = e.clientY - rect.top;
      const h = scrollable.clientHeight;
      if (y < h / 3) scrollable.scrollBy({ top: -h * 0.8, behavior: 'smooth' });
      else if (y > 2 * h / 3) scrollable.scrollBy({ top: h * 0.8, behavior: 'smooth' });
      else showPageIndicator();
    });

    scrollable.addEventListener('scroll', () => {
      if (!ticking) {
        requestAnimationFrame(() => {
          updateThumb();
          showPageIndicator();
          ticking = false;
        });
        ticking = true;
      }
      track.style.opacity = 1;
      clearTimeout(trackHideTimeout);
      trackHideTimeout = setTimeout(() => {
        track.style.opacity = 0;
      }, 800);
    });

    document.querySelectorAll('a').forEach(a => a.addEventListener('click', e => e.preventDefault()));

    function init() {
      Telegram.WebApp.ready();
      Telegram.WebApp.disableVerticalSwipes();

      updateLoadingStatus(null, '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...');

      const { site_url, cookie, user_id, title_id, chapter_number, status } = getUrlParams();
      if (!site_url || !cookie || !user_id || !title_id || !chapter_number || !status) {
        updateLoadingStatus(null, 'üü° –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã');
        return;
      }

      updateLoadingStatus(status);
      if (status === 'success') {
        fetchImages(site_url, cookie, user_id, title_id, chapter_number, status);
      }
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>
